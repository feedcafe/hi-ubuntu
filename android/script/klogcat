#!/system/bin/sh

root_path="/data"
log_path="$root_path/klogcat/"`date +%F`
screencap_path="$log_path/screencap/"

switch_channel()
{
	RANGE=2
	count=0
	event=3

	echo "###################################################################"
	echo "#                                                                 #"
	echo "#                     switch channel test                         #"
	echo "#                                                                 #"
	echo "###################################################################"

	while true
	do
		num=$RANDOM
		let "num %= $RANGE"
		let count+=1
		echo $count

		if [ $num -eq 1 ]
		then
			# send keyevent F9
			echo "send key F9"
			# input keyevent F9
			sendevent /dev/input/event$event 1 67 1
			sendevent /dev/input/event$event 0 0 0
			sendevent /dev/input/event$event 1 67 0
			sendevent /dev/input/event$event 0 0 0
			#sleep 20
		else

			# send keyevent F11
			echo "send key F11"
			# input keyevent F11
			sendevent /dev/input/event$event 1 87 1
			sendevent /dev/input/event$event 0 0 0
			sendevent /dev/input/event$event 1 87 0
			sendevent /dev/input/event$event 0 0 0
			#sleep 20
		fi
	done
}

onoff_test()
{
	count=0

	while true
	do
		# send keyevent KEYCODE_ENTER
		input keyevent 66
		sleep 1
		input keyevent 66
		sleep 17

		let count+=1
		echo tested $count times
	done
}

gtv_screencast()
{
	if [ ! -d "$screencap_path" ]; then
		mkdir -p $screencap_path
	fi
	screencap "$screencap_path/android-`date +%F-%H-%M-%S`.png"
}

btsnoop_enable()
{
	bt_stack="/system/etc/bluetooth/bt_stack.conf"
	mount -o remount,rw /system
	busybox sed -i 's/BtSnoopLogOutput=false/BtSnoopLogOutput=true/g' $bt_stack
}

gtv_get_bdaddr()
{
	cat /sys/devices/virtual/bluetooth/hci0/address > $log_path/bdaddr.txt
}

gtv_kmsg()
{
	echo `date +%F-%H-%M-%S` > $log_path/kmsg.txt
	cat /proc/kmsg >>$log_path/kmsg.txt&
}

gtv_getprop()
{
	getprop > $log_path/getprop.txt
}

gtv_getevent()
{
	echo `date +%F-%H-%M-%S` > $log_path/getevent.txt
	getevent -lt >> $log_path/getevent.txt&
}

gtv_getip()
{
	netcfg |grep eth0|busybox cut -d " " -f37
}

gtv_get_macaddr()
{
	# mac address
	netcfg |grep eth0|busybox cut -d " " -f40 > $log_path/macaddr.txt
}

gtv_bluetooth_status()
{
	adb shell am start -n "com.android.settings/.bluetooth.BluetoothSettings"
	gtv_screencast
}

gtv_pack_log()
{
	cd $root_path
	busybox tar cvf klogcat.tar klogcat
	busybox bzip2 -zvv klogcat.tar
}

gtv_internet_available()
{
	ping -c 2 g.cn
	if [ $? -eq 0 ]
	then
		echo "internet available"
	else [ $? -eq 2 ]
		echo "ping: unknown host g.cn"
	fi
}

# send plain text message using busybox sendmail applet
busybox_sendmail()
{
	echo "###################################################################"
	echo "#                                                                 #"
	echo "#                    send mail to module owner                    #"
	echo "#                  using busybox swiss army knife                 #"
	echo "#                                                                 #"
	echo "###################################################################"

	mailserver="74.208.5.15"
	mailfrom="fudong@mail.com"
	mailto="fudongbai@gmail.com"

	# need a new line between subject and mail body
	echo "Subject: someone has issue" > $log_path/mail.txt
	echo "" >> $log_path/mail.txt
	cat $log_path/getprop.txt >> $log_path/mail.txt
	busybox sendmail -v -S $mailserver -f $mailfrom \
		-au"fudong@mail.com" -ap"qwerty123" $mailto < $log_path/mail.txt
}

# send plain text message using busybox sendmail applet
busybox_sendmail_with_attachment()
{
	echo "###################################################################"
	echo "#                                                                 #"
	echo "#                   send mail to module owner                     #"
	echo "#               using busybox makemime and sendmail               #"
	echo "#                                                                 #"
	echo "###################################################################"

	mailserver="74.208.5.15"
	mailfrom="fudong@mail.com"
	mailto="fudong@mail.com"
	subject="Someone has issue"

	busybox makemime -a "Subject: $subject" \
		-o $root_path/attachment \
		$root_path/klogcat.tar.bz2
	busybox sendmail -v -S $mailserver -f $mailfrom \
		-au"fudong@mail.com" -ap"qwerty123" \
		$mailto < $root_path/attachment
}

# remove all the temp files
gtv_cleanup()
{
	rm $root_path/klogcat.tar*
	rm $root_path/attachment

	# remove outdated traces.txt
	if [ -f /data/anr/traces.txt ]; then
		rm /data/anr/traces.txt
	fi
}

main()
{
	# set timezone
	setprop persist.sys.timezone Asia/Shanghai

	# make sure directory exist
	if [ ! -d "$log_path" ]; then
		mkdir -p $log_path
	fi

	echo "log directory: $log_path"
	echo "screencap directory: $screencap_path"


	# enable btsnoop for hci debug
	btsnoop_enable

	# get kernel log
	gtv_kmsg

	# get bluetooth adapter mac address
	# gtv_get_bdaddr

	# get ethernet mac address
	gtv_get_macaddr

	# get device info
	gtv_getprop

	# bluetooth settings
	gtv_bluetooth_status

	# get current screen shot
	gtv_screencast

	# getevent
	gtv_getevent

	# pack all the log file
	gtv_pack_log

	# see if we can send mail to module owner
	#gtv_internet_available

	# send mail to module owner
	#busybox_sendmail
	busybox_sendmail_with_attachment

	gtv_cleanup
}

main
